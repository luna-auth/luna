---
import { actions } from 'astro:actions';
import Layout from '../layouts/Layout.astro';

// Get current user and session from middleware-injected locals
const user = Astro.locals.user;
const session = Astro.locals.session;

// Check if we have a result from the logout action
// This is part of the POST/Redirect/GET pattern to avoid form resubmission dialogs
const result = await Astro.getActionResult(actions.auth.logout);
if (result?.data?.success) {
  // If logout was successful, redirect to login page
  // This prevents the "confirm form resubmission" dialog on page refresh
  return Astro.redirect('/login');
}
---

<Layout title="Home">
  {
    // Conditional rendering based on authentication state
    user ? (
      <>
        <h1>Welcome, {user.email}!</h1>
        {/* Only show session ID if we have an active session */}
        {session && <p>Your session ID is: {session.id}</p>}

        {/* 
          Logout form using HTML form submission (zero JS)
          - method="POST": Ensures secure logout
          - action={actions.auth.logout}: Links to our logout action
        */}
        <form method="POST" action={actions.auth.logout}>
          <button type="submit">Logout</button>
        </form>
      </>
    ) : (
      <>
        <h1>Welcome to our site!</h1>
        <p>You are not logged in.</p>
        <p>
          <a href="/login">Login</a> or <a href="/register">Register</a>
        </p>
      </>
    )
  }
</Layout>
